<!DOCTYPE html>
<meta charset="UTF-8">
<div class="popover popover-bottom" style="position: fixed; top: 1rem; right: 1rem;">
    <button class="btn btn-lg btn-action circle" style="overflow:hidden; height: 7rem; width: 7rem;"><img id="profileGlyph" src="../pic/user.svg"></button>
    <div class="popover-container card" id="profileFrame">
        <form id="profileForm" hidden="true">
            <label class="form-label" for="profileFormName">Username</label>
            <div class="form-group">
                <span class="input-group-addon">
                    <img src="../pic/user.svg">
                </span>
                <input id="profileFormName" tabIndex="1" type="text" class="form-input" placeholder="Username" name="name" required>
            </div>
            <label class="form-label" for="profileFormPassword">Password</label>
            <div class="form-group">
                <span class="input-group-addon">
                    <img src="../pic/key.svg" style="height: 1ex; width: 1ex;">
                </span>
                <input id="profileFormPassword" tabIndex="2" type="password" class="form-input" placeholder="Password" name="password" required>
            </div>
            <button id="profileSignin" type="submit" class="btn btn-primary">Signin</button>
            <script>
            app.schedule(function(app, locals)
            {
                // handle credential input
                Rx.Observable.fromEvent(locals.root, "submit")
                    .map(function(e)
                    {
                        var name = locals.profileFormName.value;
                        var password = locals.profileFormPassword.value;

                        return { "credentials": { "name": name, "password": password } };
                    })
                    .subscribe(app.ws.send);

                // handle token values
                app.broker(app.subject.TOKEN).subscribe(function(token)
                {
                    locals.root.setAttribute("hidden", (!token));
                });
            });
            </script>
        </form>
        <div id="profileInfo" hidden="true">
            <span id="profileName"></span>
            <button id="profileSignout" class="btn btn-primary">Logout</button>
            <script>
            app.schedule(function(app, locals)
            {
                // handle click
                Rx.Observable.fromEvent(locals.profileSignout, "click")
                    .map(function(e)
                    {
                        return { "credentials": {} };
                    })
                    .subscribe(app.ws.send);

                // handle token values
                app.broker(app.subject.TOKEN).subscribe(function(token)
                {
                    locals.root.setAttribute("hidden", (!!token));
                });

                // handle login name changes
                app.broker(app.subject.CREDENTIALS).subscribe(function(credentials)
                {
                    locals.profileName.textContent = (credentials && credentials.name) ? credentials.name : "";
                });
            });
            </script>
        </div>
    </div>
    <script>
        app.schedule(function(app, locals)
        {
            // handle token values
            app.broker(app.subject.TOKEN).subscribe(function(token)
            {
                console.log("[profile-fragment] token: ", token);

                // persist token
                if (app.storageAvailable("localStorage"))
                {
                    window.localStorage.setItem(app.subject.TOKEN, token);
                }

                // update profile glyph
                locals.profileGlyph.src = (token) ? "../pic/admin-user.svg" : "../pic/user.svg";
            });

            // on token changes, if token is empty, redirect to index if not already there
            app.broker(app.subject.TOKEN)
                .filter(function(token) { return (!token); })
                .flatMap(function(token) { return app.broker(app.subject.NEXT_ROUTE); })
                .filter(function(route) { return route.strippedPath !== "" && route.strippedPath !== "/"; })
                .take(1)
                .subscribe(function(route)
                {
                    console.log("[profile-fragment] not authenticated: cancel routing attempt and navigate to: /");
                    route.subscription.unsubscribe();
                    app.navigate("/");
                });

            // initialize TOKEN with stored token
            app.broker(app.subject.TOKEN, function()
                {
                    var initialToken = "";
                    if (app.storageAvailable("localStorage"))
                    {
                        initialToken = window.localStorage.getItem(app.subject.TOKEN);
                        if (!initialToken)
                        {
                            initialToken = "";
                        }
                    }
                    return Rx.Observable.of(initialToken);
                }, true)
                .pull();
        });
        </script>
</div>