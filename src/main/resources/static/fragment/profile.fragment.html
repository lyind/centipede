<!DOCTYPE html>
<meta charset="UTF-8">
<link rel="stylesheet" href="core/app.css">
<script src="/core/app.js"></script>
<div class="popover popover-left" style="position: fixed; top: 1rem; right: 1rem;">
    <button class="btn btn-lg btn-action circle" style="overflow:hidden; height: 7rem; width: 7rem;"><img class="no-touch" id="profileGlyph" src="../pic/user.svg"></button>
    <div class="popover-container" style="margin-top:10rem; margin-right:-5rem;">
        <div id="profileFrame" class="card text-left">
            <div class="card-title"><h3>Profile</h3></div>
            <div class="card-body">
                <form id="profileForm" hidden="">
                    <label class="form-label" for="profileFormName">Username</label>
                    <div class="input-group">
                        <div class="input-group-addon addon-lg" style="width: 4rem; padding:0; background-image: none, url('../pic/user.svg'); background-size: contain; background-repeat: no-repeat;"></div>
                        <input id="profileFormName" tabIndex="1" type="text" class="form-input input-lg" placeholder="Username" name="name" required>
                    </div>
                    <label class="form-label" for="profileFormPassword">Password</label>
                    <div class="input-group">
                        <div class="input-group-addon addon-lg" style="width: 4rem; padding:0; background-image: none, url('../pic/key.svg'); background-size: contain; background-repeat: no-repeat;"></div>
                        <input id="profileFormPassword" tabIndex="2" type="password" class="form-input input-lg" placeholder="Password" name="password" required>
                    </div>
                    <br />
                    <button id="profileSignin" type="submit" class="btn btn-primary">Signin</button>
                    <script>
                    app(function(that, app)
                    {
                        // handle credential input
                        app.eachSubmit(that.parent)
                            .map(function(e)
                            {
                                var name = that.profileFormName.value;
                                var password = that.profileFormPassword.value;

                                return { "credentials": { "name": name, "password": password }, "token": "" };
                            })
                            .subscribe(app.ws);

                        // handle token values
                        app.broker(app.subject.TOKEN)
                            .subscribe(function(token)
                        {
                            app.hide(that.parent, !!token);
                        });
                    });
                    </script>
                </form>
                <div id="profileInfo" hidden="">
                    <h4 id="profileName"></h4>
                    <button id="profileSignout" class="btn btn-primary">Logout</button>
                    <script>
                    app(function(that, app)
                    {
                        // handle click
                        app.eachClick(that.profileSignout)
                            .map(function(e)
                            {
                                return { "credentials": {} };
                            })
                            .subscribe(app.ws);

                        // handle token values
                        app.broker(app.subject.TOKEN)
                            .subscribe(function(token)
                            {
                                console.log("hiding logout button");
                                app.hide(that.parent, !token);
                            });

                        // handle login name changes
                        app.broker(app.subject.CREDENTIALS)
                            .subscribe(function(credentials)
                            {
                                that.profileName.textContent = (credentials && credentials.name) ? credentials.name : "";
                            });
                    });
                    </script>
                </div>
            </div>
        </div>
    </div>
    <script>
        app(function(that, app)
        {
            // initialize TOKEN from localStorage
            app.broker(app.subject.TOKEN, function()
                {
                    var initialToken = "";
                    if (app.storageAvailable("localStorage"))
                    {
                        initialToken = window.localStorage.getItem(app.subject.TOKEN);
                        if (!initialToken)
                        {
                            initialToken = "";
                        }
                        initialToken = "";
                    }
                    return Rx.Observable.of(initialToken);
                }, true)
                .pull()
                // update profile fragment UI state
                .do(function(token)
                {
                    // persist token
                    if (app.storageAvailable("localStorage"))
                    {
                        if (token)
                            window.localStorage.setItem(app.subject.TOKEN, token);
                        else
                            window.localStorage.removeItem(app.subject.TOKEN);
                    }

                    // update profile glyph
                    that.profileGlyph.src = (token) ? "../pic/admin-user.svg" : "../pic/user.svg";
                })
                // on token changes, if token is empty, redirect to index if not already there
                .filter(function(token) { return !token; })
                .flatMap(function(token) { return app.broker(app.subject.NEXT_ROUTE); })
                .take(1)
                .filter(function(route) { return route.strippedPath !== "/signin.html" && route.strippedPath !== "signin.html"; })
                .subscribe(function(route)
                {
                    console.log("[profile-fragment] cancel routing to " + route.strippedPath + ", please sign in first");
                    route.subscription.unsubscribe();
                    app.navigate("/signin.html");
                });

            // if we were on the signin page and received a token, navigate back to index (improve this)
            app.broker(app.subject.TOKEN)
                .filter(function(token) { return !!token; })
                .flatMap(function(token) { return app.broker(app.subject.ROUTE); })
                .take(1)
                .filter(function(route) { return route.strippedPath === "/signin.html" || route.strippedPath === "signin.html"; })
                .subscribe(function(route)
                {
                    console.log("[profile-fragment] signed in");
                    app.navigate("/");
                });

            // reset token on UNAUTHORIZED error
            app.broker(app.subject.ERROR)
                //.filter(function(error) { return "UNAUTHORIZED" === error; })
                .subscribe(function(unauthorized)
                {
                    console.log("error: ", unauthorized);
                    app.broker(app.subject.TOKEN, function() { return Rx.Observable.of(""); });
                });
        });
        </script>
</div>