<!DOCTYPE html>
<meta charset="utf-8"/>
<link rel="stylesheet" href="/core/app.css">
<title>Centipede Index</title>
<script src="/core/app.js"></script>
<h1>Please enable JavaScript to use this application.
    <script>document.currentScript.parentNode.setAttribute("hidden", "");</script>
</h1>
<div data-keep="fragment/profile.fragment.html"></div>
<div>
    <h2>Services</h2>
    <div class="divider"></div>
    <div data-id="serviceList" class="columns">
        <div data-id="serviceTemplate" class="column col-4 col-lg-6 col-sm-10 col-xs-12" hidden="">
            <div class="panel">
                <div class="panel-body">
                    <div data-id="serviceLoading" class="loading"></div>
                    <div class="columns">
                        <img data-id="serviceStateGlyph" class="no-touch column col-3"
                            src="pic/unknown.svg">
                        <div class="column col-9">
                            <div data-id="serviceName" class="panel-title text-ellipsis"></div>
                            <div data-id="serviceRoute" class="panel-subtitle text-ellipsis"></div>
                            <div class="divider"></div>
                            <div class="btn-group">
                                <button data-id="serviceEnableButton" class="btn btn-sm active">Enable</button>
                                <button data-id="serviceDisableButton" class="btn btn-sm">Disable</button>
                            </div>
                            <div class="btn-group float-right">
                                <button data-id="serviceEditButton" class="btn btn-primary btn-sm">Configure</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            app(function (that, app)
            {
                app.require("core/array-adapter.js",
                    function ()
                    {
                        var services = app.broker(app.subject.TOKEN)
                            .takeUntil(app.navigate())
                            .filter(function (token)
                            {
                                return !!token;
                            })
                            .merge(app.broker(app.subject.OVERFLOW).takeUntil(app.navigate()))
                            .flatMap(function ()
                            {
                                return app.broker(app.subject.SERVICES).takeUntil(app.navigate());
                            })

                        var adapter = app.arrayAdapter(that.serviceTemplate, services);

                        adapter.added()
                            .takeUntil(app.navigate())
                            .subscribe(function (added)
                            {
                                var itemRemoved = app.navigate().merge(added.removed);

                                app.broker([app.subject.SERVICES, added.value])
                                    .takeUntil(itemRemoved)
                                    .subscribe(function (service)
                                    {
                                        app.hide(added.serviceLoading);
                                        added.serviceName.innerText = service.name;
                                        added.serviceRoute.innerText = service.route;

                                        // enable the right button
                                        switch (service.targetState)
                                        {
                                            case "UP":
                                                added.serviceEnableButton.classList.add("active");
                                                added.serviceDisableButton.classList.remove("active");
                                                break;
                                            case "DOWN":
                                                added.serviceEnableButton.classList.remove("active");
                                                added.serviceDisableButton.classList.add("active");
                                                break;
                                            default:
                                                added.serviceEnableButton.classList.remove("active");
                                                added.serviceDisableButton.classList.remove("active");
                                                break;
                                        }

                                        var stateGlyph = "unknown";
                                        switch (service.state)
                                        {
                                            case "DOWN":
                                                stateGlyph = "down";
                                                break;
                                            case "CHANGING":
                                                stateGlyph = "changing";
                                                break;
                                            case "UP":
                                                stateGlyph = "up";
                                                break;
                                        }
                                        added.serviceStateGlyph.src = "pic/" + stateGlyph + ".svg";
                                    });

                                app.eachClick(added.serviceEditButton)
                                    .takeUntil(itemRemoved)
                                    .map(function (e)
                                    {
                                        return "service-edit.html/:" + added.value;
                                    })
                                    .subscribe(app.navigate);

                                app.eachClick(added.serviceEnableButton)
                                    .takeUntil(itemRemoved)
                                    .map(function (e)
                                    {
                                        return {"services": [{"name": added.value, "targetState": "UP"}]};
                                    })
                                    .subscribe(app.ws);

                                app.eachClick(added.serviceDisableButton)
                                    .takeUntil(itemRemoved)
                                    .map(function (e)
                                    {
                                        return {"services": [{"name": added.value, "targetState": "DOWN"}]};
                                    })
                                    .subscribe(app.ws);
                            });

                        app.broker(app.subject.TOKEN)
                            .takeUntil(app.navigate())
                            .distinctUntilChanged()
                            .map(function (token)
                            {
                                return {services: []};
                            })
                            .subscribe(function (request)
                            {
                                console.log("[index] requesting services");
                                app.ws(request);
                            });
                    });
            });
        </script>
    </div>
    <script>

    </script>
</div>