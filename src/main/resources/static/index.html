<!DOCTYPE html>
<meta charset="utf-8"/>
<link rel="stylesheet" href="/core/app.css">
<title>Centipede Index</title>
<script src="/core/app.js"></script>
<h1>Please enable JavaScript to use this application.
    <script>document.currentScript.parentNode.setAttribute("hidden", "");</script>
</h1>
<div data-id="profile.fragment" data-keep="fragment/profile.fragment.html"></div>
<div>
    <h2 data-id="titleNode">Services on </h2>
    <div data-id="serviceList" class="columns">
        <div data-id="serviceTemplate" class="column col-3 col-xs-6" hidden="">
            <div class="card">
                <div class="card-header">
                    <span class="card-image">
                        <img data-id="serviceStateGlyph" class="no-touch img-responsive" style="height: 2rem; width: 2rem;"
                             src="pic/unknown.svg">
                    </span>
                    <h4  data-id="serviceName" class="card-title"></h4>
                    <h6 class="card-subtitle"><span>State: </span><span data-id="serviceState"></span></h6>
                </div>
                <div class="card-body">
                    <div class="btn-group">
                        <button class="btn btn-sm active">Enabled</button>
                        <button class="btn btn-sm">Disabled</button>
                    </div>
                </div>
                <div class="card-footer">
                    <button data-id="serviceEditButton" class="btn btn-primary">Configure</button>
                </div>
            </div>
        </div>

        <script>
            app(function (that, app)
            {
                app.require("core/array-adapter.js",
                    function ()
                    {
                        var services = app.broker(app.subject.TOKEN)
                            .filter(function (token)
                            {
                                return !!token;
                            })
                            .flatMap(function ()
                            {
                                return app.broker(app.subject.SERVICES);
                            })
                            .takeUntil(app.navigate());

                        var adapter = app.arrayAdapter(that.serviceTemplate, services);

                        adapter.added()
                            .takeUntil(app.navigate())
                            .subscribe(function (added)
                            {
                                var itemRemoved = app.navigate().merge(added.removed);

                                app.broker([app.subject.SERVICES, added.value])
                                    .takeUntil(itemRemoved)
                                    .subscribe(function (service)
                                    {
                                        added.serviceName.innerText = service.name;
                                        added.serviceState.innerText = service.state;

                                        var stateGlyph = "unknown";
                                        switch (service.state)
                                        {
                                            case "DOWN":
                                                stateGlyph = "down";
                                                break;
                                            case "CHANGING":
                                                stateGlyph = "changing";
                                                break;
                                            case "UP":
                                                stateGlyph = "up";
                                                break;
                                        }
                                        added.serviceStateGlyph.src = "pic/" + stateGlyph + ".svg";
                                    });

                                app.eachClick(added.serviceEditButton)
                                    .takeUntil(itemRemoved)
                                    .map(function (e)
                                    {
                                        return "service-edit.html/:" + added.value;
                                    })
                                    .subscribe(app.navigate);
                            });

                        app.broker(app.subject.TOKEN)
                            .takeUntil(app.navigate())
                            .distinctUntilChanged()
                            .map(function (token)
                            {
                                return {services: []};
                            })
                            .subscribe(function (request)
                            {
                                console.log("[index] requesting services");
                                app.ws(request);
                            });
                    });
            });
        </script>
    </div>
    <script>

    </script>
</div>